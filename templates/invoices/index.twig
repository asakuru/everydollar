{% extends "layout.twig" %}

{% block title %}Invoices - {{ app_name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-white">Invoices</h1>
             <p class="text-gray-400 text-sm mt-1">Managing invoices for <span class="text-emerald-400 font-semibold">{{ current_entity.name }}</span></p>
        </div>
        <a href="{{ base_path('/invoices/create') }}" class="btn btn-primary">
            + New Invoice
        </a>
    </div>

    <!-- Invoices List -->
    <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-900/50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Number</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Client</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Due Date</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for invoice in invoices %}
                <tr class="hover:bg-gray-750">
                     <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if invoice.status == 'paid' %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-900 text-emerald-300">Paid</span>
                        {% elseif invoice.status == 'sent' %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-900 text-blue-300">Sent</span>
                        {% elseif invoice.status == 'overdue' %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-900 text-red-300">Overdue</span>
                        {% else %}
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-700 text-gray-300">Draft</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">#{{ invoice.invoice_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ invoice.client_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ invoice.due_date|date('M d, Y') }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-white">${{ (invoice.amount_cents / 100)|number_format(2) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        {% if invoice.status == 'draft' %}
                            <form action="{{ base_path('/invoices/' ~ invoice.id ~ '/sent') }}" method="POST" class="inline">
                                {{ csrf_field()|raw }}
                                <button type="submit" class="text-blue-400 hover:text-blue-300">Mark Sent</button>
                            </form>
                        {% endif %}
                        
                        {% if invoice.status == 'sent' or invoice.status == 'overdue' %}
                            <button onclick="openPaymentModal({{ invoice.id }}, '{{ invoice.invoice_number }}')" 
                                    class="text-emerald-400 hover:text-emerald-300 font-medium">
                                Mark Paid
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                        No invoices found. <a href="{{ base_path('/invoices/create') }}" class="text-emerald-400 hover:underline">Create one</a>.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden overflow-y-auto h-full w-full backdrop-blur-sm flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-gray-800 border-gray-700">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-white">Record Payment</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-400 mb-4">
                        Mark Invoice #<span id="modalInvoiceNumber" class="font-bold text-white"></span> as paid?
                    </p>
                    
                    <form id="paymentForm" method="POST">
                        {{ csrf_field()|raw }}
                        
                        <div class="mb-4 text-left">
                            <label class="block text-gray-400 text-sm font-bold mb-2" for="paid_date">
                                Payment Date
                            </label>
                            <input type="date" name="paid_date" id="paid_date" required
                                   value="{{ 'now'|date('Y-m-d') }}"
                                   class="shadow appearance-none border border-gray-600 rounded w-full py-2 px-3 text-white bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>

                        <div class="mb-4 text-left">
                            <label class="block text-gray-400 text-sm font-bold mb-2" for="account_id">
                                Deposit To Account
                            </label>
                            <select name="account_id" id="account_id" required
                                    class="shadow border border-gray-600 rounded w-full py-2 px-3 text-white bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Select Account...</option>
                                {% for account in accounts %}
                                    <option value="{{ account.id }}">{{ account.name }} ({{ account.type|capitalize }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="items-center px-4 py-3">
                            <button type="submit"
                                    class="px-4 py-2 bg-emerald-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                Confirm Payment
                            </button>
                            <button type="button" onclick="closePaymentModal()"
                                    class="mt-3 px-4 py-2 bg-gray-700 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openPaymentModal(id, number) {
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('modalInvoiceNumber').innerText = number;
            document.getElementById('paymentForm').action = "{{ base_path('/invoices/') }}" + id + "/paid";
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }
    </script>
</div>
{% endblock %}
